# 이벤트 루프와 매크로·마이크로태스크
- Node.js/브라우저 자바스크립트 실행 흐름은 이벤트 루프 기반

## 이벤트 루프
- 태스크가 들어오면 순차적으로 처리하고, 태스크가 없으면 대기타는, 끊임없이 돌아가는 js내 루프
- js엔진은 보통 놀다가 스크립트, 핸들러, 이벤트 활성화되면 일함
    - 태스크들의 집합을 순차적으로 다 처리하고 노는 동안 cpu자원 소비는 0에 가까움. js엔진은 잔다.
    - js엔진이 바쁠 때 새로운 태스크는 매크로태스크 큐(v8용어임)에 추가<br>
    예) js엔진이 외부 스크립트`<script>` 처리하느라 바쁜데 `mousemove` 이벤트 활성화되고 `setTimeout` 설정 시간도 지나서 콜백도 불러야됨. -> 세 태스크는 큐에 쳐박혀 순차적으로 처리
- js엔진이 특정 태스크를 처리하는 동안 렌더링은 절대 일어나지 않음.<br>처리가 끝나면 DOM 변경을 다시 화면에 반영
- 긴 태스크 처리시간 동안 사용자의 이벤트 등 새로운 태스크를 처리 못함.<br>복잡한 계산이 필요하거나 무한루프에 빠지면 얼럿창 같은거 띄워서 사용자에게 페이지 전체와 해당 태스크를 처분을 선택하도록 유도
- 작동 순서(무한 반복)
    1. 매크로태스크 큐에서 가장 오래된 태스크 실행
    2. 모든 마이크로태스크 실행(FIFO)
    3. 렌더링할거 있으면 함
    4. 매크로태스크 큐가 비어있으면 새 태스크 올떄까지 논다.
    - UI 변화, 네트워크 이벤트 핸들링 같이 앱 환경에 변화를 주는 작업에 영향을 받지 않고 모든 마이크로태스크를 동일한 환경에서 일관성 있게 처리할 수 있기 때문에 처리순서는 매우 중요하다.


... 유스케이스...



## 매크로태스크와 마이크로태스크
![매크로마이크로태스크큐](https://uploads.disquscdn.com/images/9466d8aa53fc5b3e63a92858a94bb429df02bbd20012b738f0461343beaa6f90.gif?w=600&h=280)
- 마이크로태스크 : 코드를 사용해서만 만들 수 있음.(주로 promise 메소드, `await`, `queueMicrotask`의 인자로 넘어가는 함수)
    ```js
    // 3.`setTimeout`의 설정 시간이 끝난 후, 콜백함수 실행은 매크로태스크 큐에 들어가서 실행됨.
    setTimeout(() => alert("timeout"));

    // 2. 마이크로태스크
    Promise.resolve()
    .then(() => alert("promise")); 

    // 1. 매크로태스크
    alert("code");  
    ```
### 매크로태스크 스케쥴링하기
큰 태스크를 쪼개서 중간에 사용자 이벤트에 반응, 화면 표시 등 가능<br>
이벤트 버블링 끝난 후(완전 처리), 특정 작업 실행 스케줄링으로도 사용
1. 지연시간이 0인 `setTimeout(f)`<br>
2. `queueMicrotask(f)` 사용
3. promise 핸들러 사용